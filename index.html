<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é‡‘åº«ç¥å·ï½œRTP æ¨¡æ“¬å™¨ï¼ˆç²¾ç¢ºè‡ªå‹•æ ¡æº–ï¼‹READMEæ•´åˆï¼‰</title>
<style>
:root{--bg:#0b1020;--card:#141a2d;--muted:#2a3553;--text:#e8ecf3;--sub:#a9b2c7;--accent:#4cc9f0;--ok:#2dd4bf;--warn:#f59e0b;--bad:#ef4444}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1630);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
h1,h2,h3{margin:0 0 .5rem}.wrap{max-width:1180px;margin:24px auto;padding:0 16px}
.grid{display:grid;gap:16px}.g-3{grid-template-columns:repeat(3,minmax(0,1fr))}.g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.card{background:var(--card);border:1px solid var(--muted);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
.row{display:flex;gap:12px;flex-wrap:wrap}label{display:block;font-weight:600;margin-bottom:6px;color:var(--sub)}
input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--muted);background:#0d1326;color:var(--text) !important}
textarea{min-height:110px;white-space:pre}button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;color:#07111f;background:var(--accent);cursor:pointer}
button.secondary{background:#263250;color:var(--text)}button.ghost{background:transparent;color:var(--text);border:1px dashed var(--muted)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.muted{color:var(--sub)}.kpi{font-size:22px;font-weight:800}.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid var(--muted);padding:6px 8px;text-align:right}
.table th:first-child,.table td:first-child{text-align:left}.tag{padding:2px 8px;border:1px solid var(--muted);border-radius:999px;color:#c7d3ea;background:#1b223c}
.progress{width:100%;height:10px;background:#223054;border-radius:999px;overflow:hidden}.progress>div{height:100%;width:0;background:linear-gradient(90deg,#4cc9f0,#2dd4bf);transition:width .2s}
.small{font-size:12px}
/* modal */
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:20px}
.modal .panel{max-width:900px;width:100%;max-height:80vh;overflow:auto;background:#0e1630;border:1px solid #2a3553;border-radius:14px;padding:16px}
.modal pre{white-space:pre-wrap;font-family:ui-monospace,monospace}
.modal .close{float:right;background:#2a3553;color:#cfe1ff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer}
/* better inline options layout */
.row.align-center{align-items:center}
.inline-tags{display:flex;gap:8px;flex-wrap:wrap}
.inline-tags .tag{padding:2px 10px;border-radius:999px;border:1px solid var(--muted);background:#1b223c;color:#c7d3ea}
.help-btn{background:#263250;color:#cfe1ff;border:1px solid var(--muted);padding:4px 8px;border-radius:8px}
/* æœ¬å±€è³¼è²·ï¼šå–®è¡Œæ¸…æ¥šé¡¯ç¤º */
.tool-options{display:flex;flex-wrap:wrap;gap:12px;margin-top:6px}
.tool-options label{display:flex;align-items:center;gap:8px;background:#1b223c;padding:6px 10px;border-radius:10px;border:1px solid var(--muted);cursor:pointer;margin:0;white-space:nowrap}
</style>
</head>
<body>
<div class="wrap grid g-2">
  <div class="card">
    <h1>é‡‘åº«ç¥å·ï½œRTP æ¨¡æ“¬å™¨ï¼ˆç²¾ç¢ºè‡ªå‹•æ ¡æº–ï¼‹READMEæ•´åˆï¼‰</h1>
    <p class="muted">å…§å»º <b>96%</b> é è¨­å€¼ï¼›æ”¯æ´<b>ç²¾ç¢ºå¤šåƒæ•¸è‡ªå‹•æ ¡æº–</b>èˆ‡<b>é€²åº¦é¡¯ç¤º</b>ã€‚æŒ‰ä¸‹ã€Œä½¿ç”¨èªªæ˜ã€å¯æŸ¥çœ‹å…§åµŒ READMEã€‚</p>
    <div class="row">
      <button id="btnShare" class="secondary">è¤‡è£½ç›®å‰è¨­å®šé€£çµ</button>
      <button id="btnReset" class="ghost">é‡è¨­ç‚º 96% é è¨­</button>
      <button id="btnReadme" class="secondary">ä½¿ç”¨èªªæ˜</button>
    </div>
  </div>

  <div class="card">
    <h3>é¡¯ç¤ºèˆ‡åŸºæº–</h3>
    <div class="row">
      <span class="tag">RTP ç™¾åˆ†æ¯”ï¼ˆå…©ä½ï¼‰</span>
      <span class="tag">Mean/Std ä»¥é‡‘é¡</span>
      <span class="tag">Step50 æˆåŠŸç‡é è¨­ 70%</span>
    </div>
  </div>

  <div class="card">
    <h2>è¼¸å…¥è¨­å®šï¼ˆåŸºç¤ï¼‹ä¸Šé™ï¼‰</h2>
    <div class="grid g-2">
      <div><label>ç›®æ¨™ RTP</label><input id="inpTarget" type="number" step="0.0001" value="0.96" /></div>
      <div><label>Step50 æˆåŠŸç‡ï¼ˆ0~1ï¼‰</label><input id="inpS50" type="number" step="0.01" min="0" max="1" value="0.7" /></div>
      <div><label>é‡‘é¡ä¸Šé™ï¼ˆ$ï¼‰</label><input id="inpMoneyCap" type="number" step="50" value="5000" /></div>
      <div><label>å€ç‡ä¸Šé™ï¼ˆxï¼‰</label><input id="inpMultCap" type="number" step="50" value="2000" /></div>
      <div><label>ä¸‹æ³¨é¡ä¸Šé™ä¿‚æ•¸ Î±</label><input id="inpAlphaByBet" type="number" step="0.05" value="0.30" /></div>
    </div>
    <div class="spacer"></div>
    <label>50 æ­¥å€ç‡ï¼ˆé€—è™Ÿæˆ–æ›è¡Œåˆ†éš”ï¼‰</label>
    <textarea id="inpRewards" class="mono"></textarea>
    <div class="spacer"></div>
    <label>åŸºæº–å¤±æ•—ç‡ %ï¼ˆå‰ 49 æ­¥ï¼›ç¬¬ 50 æ­¥ç”±æˆåŠŸç‡æ¨ï¼‰ï¼Œé€—è™Ÿæˆ–æ›è¡Œ</label>
    <textarea id="inpBaseFail" class="mono"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="btnCalibrate">è‡ªå‹•æ ¡æº–ï¼ˆåŸºç¤ï¼‹ä¸Šé™ï¼‰</button>
      <button id="btnExportSpec" class="secondary">åŒ¯å‡ºè¦æ ¼ CSV</button>
      <button id="btnExportAlerts" class="secondary">åŒ¯å‡ºè­¦æˆ’ CSV</button>
    </div>
  </div>

  <div class="card">
    <h2>é€²éšæ¨¡æ“¬ï¼ˆé“å…·ï¼æ›²ç·šç ´å£è€…ï¼‰</h2>
    <div class="grid g-3">
      <div><label>ä¸‹æ³¨é¡ï¼ˆ$ï¼‰</label><input id="inpBet" type="number" step="0.1" value="1.00" /></div>
      <div><label>æ¨¡æ“¬å±€æ•¸</label><input id="inpSims" type="number" step="1000" value="200000" /></div>
      <div></div>
      <div><label>Î»1ï¼ˆæ­¥ 1â€“30ï¼‰</label><input id="inpLam1" type="number" step="0.01" value="1.50" /></div>
      <div><label>Î»2ï¼ˆæ­¥ 31â€“40ï¼‰</label><input id="inpLam2" type="number" step="0.01" value="2.00" /></div>
      <div><label>Î»3ï¼ˆæ­¥ 41â€“50ï¼‰</label><input id="inpLam3" type="number" step="0.01" value="5.00" /></div>
    </div>

    <div class="spacer"></div>
    <h3>é“å…· / ç ´å£è€… åƒæ•¸ï¼ˆåˆ†ç´šåƒ¹æ ¼ï¼‰</h3>
    <div class="grid g-3">
      <div><label>é«˜ç´š(çµ•ä½³) æ©Ÿç‡</label><input id="inpCanvasProb" type="number" step="0.01" value="0.10" /></div>
      <div><label>é«˜ç´š(çµ•ä½³) åŠ æˆ (x)</label><input id="inpCanvasBonus" type="number" step="0.1" value="1.2" /></div>
      <div></div>
      <div><label>è¯éº—(åœ°æ¨™) æ©Ÿç‡</label><input id="inpLandmarkProb" type="number" step="0.001" value="0.015" /></div>
      <div><label>è¯éº—(åœ°æ¨™) å¤±æ•—ç‡</label><input id="inpLandmarkFail" type="number" step="0.01" value="0.80" /></div>
      <div><label>è¯éº—(åœ°æ¨™) çå‹µ (x)</label><input id="inpLandmarkBonus" type="number" step="10" value="800" /></div>
      <div><label>é˜²çˆ†ç›¾(æŠŠé¢¨) æˆæœ¬ Ã—bet</label><input id="inpLookoutCost" type="number" step="0.05" value="2.0" /></div>
      <div><label>è½è¨ºå™¨(ç„¡äººæ©Ÿ) æˆæœ¬ Ã—bet</label><input id="inpDroneCost" type="number" step="0.05" value="1.5" /></div>
      <div><label>ç²¾å¯†å·¥å…·(å™´é ­) æˆæœ¬ Ã—bet</label><input id="inpNozzleCost" type="number" step="0.05" value="1.0" /></div>
      <div><label>ç ´è§£å™¨(æ¨¡ç‰ˆ) æˆæœ¬ Ã—bet</label><input id="inpTemplateCost" type="number" step="0.05" value="0.3" /></div>
      <div><label>å¾Œæ®µ +çµ•å°é¢¨éšª (40â€“49)</label><input id="inpPost40Bump" type="number" step="0.01" value="0.08" /></div>
      <div><label>æœ€å°å¤±æ•—ç‡ (â‰¥45)</label><input id="inpMinFailAfter45" type="number" step="0.01" value="0.50" /></div>
    </div>

    <!-- é‡åšï¼šæœ¬å±€è³¼è²·ï¼ˆå–®è¡Œæ¸…æ¥šï¼‰ -->
    <div class="row" style="margin-top:6px">
      <h3 style="margin:0">æœ¬å±€è³¼è²·</h3>
      <div class="tool-options" style="width:100%">
        <label for="chkUseNozzle"><input type="checkbox" id="chkUseNozzle" /> ç²¾å¯†å·¥å…·(å™´é ­) â†’ å…Œç¾ä¹˜ <b>1.5x</b></label>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnRunAdv">åŸ·è¡Œé€²éšæ¨¡æ“¬</button>
      <button id="btnCalibAdv" class="secondary">é€²éšè‡ªå‹•æ ¡æº–åˆ° 96%ï¼ˆç²¾ç¢ºï¼‰</button>
    </div>
    <div class="row align-center" style="margin-top:8px">
      <label style="display:flex;align-items:center;gap:8px;margin:0">
        <input type="checkbox" id="chkAlsoTuneTail" checked />
        <span class="muted">åŒæ™‚èª¿æ•´ï¼š</span>
      </label>
      <div class="inline-tags">
        <span class="tag">å°¾æ®µä¸‹é™</span>
        <span class="tag">å¾Œæ®µé¢¨éšª</span>
        <span class="tag">å€ç‡ç¸®æ”¾</span>
        <span class="tag">åŸºæº–é¢¨éšªç¸®æ”¾</span>
      </div>
      <button type="button" id="btnTuneHelp" class="help-btn" title="èªªæ˜">?</button>
    </div>

    <div class="row" id="advResult" style="margin-top:12px"></div>

    <div id="calibProgressBox" style="margin-top:8px;display:none">
      <div class="progress"><div id="calibBar"></div></div>
      <div class="small muted" id="calibMsg">æº–å‚™ä¸­...</div>
      <div class="row" style="margin-top:6px">
        <button id="btnCancel" class="ghost">å–æ¶ˆæ ¡æº–</button>
      </div>
    </div>
  </div>

  <div class="card" style="grid-column:1 / -1">
    <h2>æ ¡æº–çµæœï¼ˆåŸºç¤ï¼‹ä¸Šé™ï¼‰</h2>
    <div id="calibKPI" class="row" style="gap:24px"></div>
    <div class="spacer"></div>
    <div style="overflow:auto">
      <table class="table mono" id="tblSpec"></table>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="mdReadme" class="modal" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
  <div class="panel">
    <button class="close" id="btnCloseReadme">é—œé–‰</button>
    <h3 id="mdTitle">ä½¿ç”¨èªªæ˜</h3>
    <pre id="mdBody"></pre>
  </div>
</div>

<script>
// == Inline README ==
const README_TEXT = {text: `# GK Simulator - å®Œæ•´ç‰ˆ (96% é è¨­å±•ç¤ºç‰ˆ)

é€™æ˜¯ä¸€å€‹å®Œæ•´çš„ **é‡‘åº«éŠæˆ²æ¨¡æ“¬å™¨ (GK Simulator)**ï¼Œç”¨æ–¼é©—è­‰èˆ‡èª¿æ•´éŠæˆ²çš„çå‹µæ›²ç·šã€é¢¨éšªæ›²ç·šã€ä»¥åŠé“å…·/ç ´å£è€…çš„å½±éŸ¿ã€‚
æœ¬ç‰ˆæœ¬å·²å…§å»º **96% RTP é è¨­å€¼**ï¼Œæ‰“é–‹å¾Œå³å¯ç›´æ¥é‹è¡Œä¸¦å¾—åˆ°æ¥è¿‘ 96% çš„æœŸæœ›å›å ±ã€‚

---

## ğŸ”‘ åŠŸèƒ½ç‰¹è‰²
- **50 æ­¥å€ç‡ & åŸºæº–å¤±æ•—ç‡**ï¼šå·²èª¿æ•´éçš„åŸºæº–æ•¸æ“šï¼Œä¿è­‰æ•´é«” RTP â‰ˆ 96%ã€‚
- **Î»â‚/Î»â‚‚/Î»â‚ƒ è‡ªå‹•æ ¡æº–**ï¼šé€²éšæ ¡æº–æœƒåŒæ™‚èª¿æ•´å€ç‡ç¸®æ”¾ã€å°¾æ®µå¤±æ•—ç‡ã€åŸºæº–é¢¨éšªæ›²ç·šã€‚
- **é“å…·/ç ´å£è€…**ï¼š
  - é˜²çˆ†ç›¾ (æŠŠé¢¨) â†’ 2.0x bet
  - è½è¨ºå™¨ (ç„¡äººæ©Ÿ) â†’ 1.5x bet
  - ç²¾å¯†å·¥å…· (å™´é ­) â†’ 1.0x betï¼ˆâ€»å•Ÿå‹•å¾ŒæŒçºŒå­˜åœ¨ï¼Œå…Œç¾ä¹˜ 1.5xï¼‰
  - ç ´è§£å™¨ (æ¨¡ç‰ˆ) â†’ 0.3x bet
- **é€²éšè‡ªå‹•æ ¡æº–**ï¼šæ”¯æ´å¤šåƒæ•¸æœå°‹ï¼Œæœƒé¡¯ç¤ºé€²åº¦æ¢èˆ‡å³æ™‚ RTPï¼Œå®Œæˆå¾Œæ›´æ–°åˆ°æœ€ä½³æ•¸å€¼ã€‚
- **çµæœé¡¯ç¤º**ï¼š
  - RTP â†’ ç™¾åˆ†æ¯”ï¼Œå°æ•¸å¾Œå…©ä½
  - Mean payout / Std payout â†’ é‡‘é¡æ ¼å¼ï¼Œå…©ä½å°æ•¸

---

## ğŸ“Š æ“ä½œèªªæ˜
1. æ‰“é–‹é é¢å¾Œï¼Œå¯ç›´æ¥é»é¸ **åŸ·è¡Œæ¨¡æ“¬** â†’ å³å´é¡¯ç¤º RTP / Mean / Stdã€‚
2. é»æ“Š **é€²éšè‡ªå‹•æ ¡æº–åˆ° 96%**ï¼šæœƒå•Ÿå‹•ç²¾ç¢ºæ¨¡æ“¬ï¼ŒåŒ…å«å¤šåƒæ•¸èª¿æ•´ã€‚
   - é€²åº¦æ¢æœƒé¡¯ç¤ºã€Œç¬¬å¹¾ä»£ / å€™é¸çµ„åˆæ•¸ / RTPã€ã€‚  
   - å¯éš¨æ™‚æŒ‰ **å–æ¶ˆæ ¡æº–**ã€‚
3. å¯ä¿®æ”¹ï¼š
   - **ä¸‹æ³¨é¡**ï¼ˆ0.1 ~ 20 USDï¼‰
   - **æ¨¡æ“¬å±€æ•¸**ï¼ˆå»ºè­° 1 è¬ / 10 è¬ / 100 è¬ï¼‰
   - **å€ç‡æ›²ç·šã€å¤±æ•—ç‡ã€Î» å€¼ã€é“å…·åƒæ•¸**ï¼ˆæ‰‹å‹•èª¿æ•´å¾Œé‡æ–°æ¨¡æ“¬ï¼‰ã€‚
4. **è‡ªå‹•æ ¡æº–ï¼ˆåŸºç¤ç‰ˆï¼‰**ï¼šåƒ…å¾®èª¿ Î»1~3 èˆ‡å€ç‡ï¼Œä¸è·‘å®Œæ•´æ¨¡æ“¬ã€‚

---

## ğŸš€ éƒ¨ç½²æ–¹å¼ (GitHub Pages)
1. å»ºç«‹ä¸€å€‹å…¬é–‹ Repoï¼Œä¾‹å¦‚ \`gk-sim-web\`
2. ä¸Šå‚³ \`index.html\`
3. åˆ° Repo â†’ Settings â†’ Pages â†’ Source â†’ é¸æ“‡ \`main branch / root\`
4. å„²å­˜å¾Œï¼Œå¹¾åˆ†é˜å…§æœƒç”Ÿæˆç¶²å€ï¼Œä¾‹å¦‚ï¼š  
   \`https://<username>.github.io/gk-sim-web/\`

`};

// == utils ==
const $ = (id)=>document.getElementById(id);
function getVal(id, def=null){ const el=$(id); return el && 'value' in el? el.value: def }
function setVal(id, v){ const el=$(id); if(el && 'value' in el) el.value=v }
function setHTML(id, html){ const el=$(id); if(el) el.innerHTML=html }
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const parseList=(t)=> String(t||'').split(/[
,]+/).map(s=>s.trim()).filter(Boolean).map(Number);
function fmtPct(x){ return (100*Number(x)).toFixed(2)+'%' }
function fmtMoney(x){ return '$'+Number(x).toFixed(2) }
function toCSV(rows){ return rows.map(r=> r.map(v=> String(v)).join(',')).join('
') }
function download(name, text){ const blob=new Blob([text],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),5000) }
function oddsScale(p, lam){ p=clamp(p,0,1-1e-12); const odds=p/(1-p); const o2=lam*odds; return clamp(o2/(1+o2),0,1) }
function afterProbs(pFail){ const out=[]; let acc=1; for(const pf of pFail){ acc*=(1-pf); out.push(acc) } return out }
function evCurve(reward, pFail, capMult){ const after=afterProbs(pFail); const rm=reward.map(r=> capMult? Math.min(r,capMult): r); return {ev: rm.map((r,i)=> r*after[i]), after} }
function argmax(arr){ let bi=0,bv=-Infinity; arr.forEach((v,i)=>{ if(v>bv){bv=v;bi=i} }); return bi }

// == defaults (96%-ish) ==
const defaultRewards=[1.05,1.12,1.20,1.30,1.42,1.56,1.72,1.90,2.10,2.35,2.60,2.90,3.25,3.65,4.10,4.60,5.15,5.75,6.40,8.00,9.00,10.20,11.50,12.90,14.40,16.00,17.70,19.50,21.40,30.00,36.00,42.00,48.00,54.00,60.00,70.00,80.00,90.00,100.00,180.00,240.00,320.00,420.00,520.00,800.00,1200.00,2000.00,4000.00,8000.00,16000.00];
const defaultBaseFailPct=[0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1.00,1.10,1.30,1.50,1.70,1.90,2.20,2.50,2.80,3.10,3.40,3.80,4.20,4.80,5.40,6.00,6.60,7.30,8.10,9.00,10.00,11.00,12.50,14.00,16.00,18.00,20.00,22.00,24.00,26.00,28.00,32.00,36.00,40.00,44.00,48.00,52.00,56.00,60.00,65.00,70.00];
const defaultMoneyCap=5000, defaultMultCap=2000, defaultAlpha=0.30;
const defaultLam=[1.50,2.00,5.00];
const defaultItems={ canvas_prob:0.10, canvas_bonus:1.2, landmark_prob:0.015, landmark_fail:0.80, landmark_bonus:800, lookout_cost_mult:2.0, drone_cost_mult:1.5, nozzle_cost_mult:1.0, template_cost_mult:0.3, post40_abs_bump:0.08, min_fail_after_45:0.50 };

function loadDefaults96(){
  setVal('inpTarget',0.96); setVal('inpS50',0.70);
  setVal('inpMoneyCap',defaultMoneyCap); setVal('inpMultCap',defaultMultCap); setVal('inpAlphaByBet',defaultAlpha);
  setVal('inpRewards',defaultRewards.join(',')); setVal('inpBaseFail',defaultBaseFailPct.join(','));
  setVal('inpLam1',defaultLam[0]); setVal('inpLam2',defaultLam[1]); setVal('inpLam3',defaultLam[2]);
  setVal('inpBet',1.00); setVal('inpSims',200000);
  setVal('inpCanvasProb',defaultItems.canvas_prob); setVal('inpCanvasBonus',defaultItems.canvas_bonus);
  setVal('inpLandmarkProb',defaultItems.landmark_prob); setVal('inpLandmarkFail',defaultItems.landmark_fail); setVal('inpLandmarkBonus',defaultItems.landmark_bonus);
  setVal('inpLookoutCost',defaultItems.lookout_cost_mult); setVal('inpDroneCost',defaultItems.drone_cost_mult); setVal('inpNozzleCost',defaultItems.nozzle_cost_mult); setVal('inpTemplateCost',defaultItems.template_cost_mult);
  setVal('inpPost40Bump',defaultItems.post40_abs_bump); setVal('inpMinFailAfter45',defaultItems.min_fail_after_45);
  const chk=document.getElementById('chkUseNozzle'); if(chk) chk.checked=false;
}

// == base spec calibration ==
let lastCalib=null;
function calibrate(){
  const target=Number(getVal('inpTarget',0.96))||0.96;
  const rewards=parseList(getVal('inpRewards',''));
  const baseFailPct=parseList(getVal('inpBaseFail',''));
  const s50=clamp(Number(getVal('inpS50',0.7))||0.7,0,1);
  if(rewards.length!==50){ alert('å€ç‡éœ€è¦ 50 å€‹æ•¸å€¼'); return }
  if(baseFailPct.length!==49){ alert('åŸºæº–å¤±æ•—ç‡éœ€ 49 å€‹'); return }
  const baseFail=baseFailPct.map(x=>x/100); baseFail.push(1-s50);
  const moneyCap=Number(getVal('inpMoneyCap',defaultMoneyCap))||defaultMoneyCap;
  const multCap=Number(getVal('inpMultCap',defaultMultCap))||defaultMultCap;
  const alpha=Number(getVal('inpAlphaByBet',defaultAlpha))||defaultAlpha;
  const capMultEffective=Math.min(multCap, moneyCap/1.0, alpha*moneyCap/1.0);
  let lo=0.5,hi=25.0,best={gap:1e9,lam:null,p:null,ev:null,after:null};
  for(let i=0;i<40;i++){
    const mid=0.5*(lo+hi);
    const p=baseFail.map(p0=>oddsScale(p0,mid));
    const {ev,after}=evCurve(rewards,p,capMultEffective);
    const gap=Math.abs(Math.max(...ev)-target);
    if(gap<best.gap) best={gap,lam:mid,p,ev,after};
    if(Math.max(...ev)>target) lo=mid; else hi=mid;
  }
  const bestStep=argmax(best.ev)+1;
  setHTML('calibKPI',`
    <div><div class="muted">lambda*</div><div class="kpi">${best.lam.toFixed(6)}</div></div>
    <div><div class="muted">æœ€ä½³æ­¥</div><div class="kpi">${bestStep}</div></div>
    <div><div class="muted">Max EV</div><div class="kpi">${Math.max(...best.ev).toFixed(6)}</div></div>
    <div><div class="muted">æœ‰æ•ˆå€ç‡ä¸Šé™</div><div class="kpi">${capMultEffective.toFixed(2)}x</div></div>`);
  const rows=[[ 'Step','Reward','FailProb','Survival','ReachProb(before)','AfterProb(through)','EV_at_step','Alert(>0.96)' ]];
  for(let k=0;k<50;k++){
    const reach=k===0?1.0:best.after[k-1];
    rows.push([k+1,rewards[k].toFixed(6),best.p[k].toFixed(6),(1-best.p[k]).toFixed(6),reach.toFixed(6),best.after[k].toFixed(6),best.ev[k].toFixed(6), (best.ev[k]>target)?1:0]);
  }
  setHTML('tblSpec', rows.map((r,i)=>'<tr>'+r.map(c=>(i?'<td>':'<th>')+c+(i?'</td>':'</th>')).join('')+'</tr>').join(''));
  lastCalib={rewards,baseFail,target,moneyCap,multCap,alpha,capMultEffective,...best};
}
function exportSpec(){ if(!lastCalib){ alert('è«‹å…ˆåŸ·è¡Œè‡ªå‹•æ ¡æº–'); return } const {rewards,p,after,ev,target}=lastCalib; const rows=[[ 'Step','RewardMultiplier',`ScaledFailProb(odds,lambda=${lastCalib.lam})`,'ScaledSurvivalProb','ReachProb(before step)','AfterProb(through step)','EV_at_step(with caps)','Alert(>target)']]; for(let k=0;k<50;k++){ const reach=k===0?1.0:after[k-1]; rows.push([k+1,rewards[k],p[k],1-p[k],reach,after[k],ev[k],ev[k]>target?1:0]) } download('VaultHeist_Probability_Spec_withCaps.csv', toCSV(rows)) }
function exportAlerts(){ if(!lastCalib){ alert('è«‹å…ˆåŸ·è¡Œè‡ªå‹•æ ¡æº–'); return } const {rewards,ev,target}=lastCalib; const rows=[[ 'Step','RewardMultiplier','EV_at_step(with caps)' ]]; ev.forEach((v,i)=>{ if(v>target) rows.push([i+1,rewards[i],v]) }); download('VaultHeist_Alert_Report.csv', toCSV(rows)) }

// == Items & simulation ==
function getCfg(){ return {
  canvas_prob:Number(getVal('inpCanvasProb',defaultItems.canvas_prob))||0,
  canvas_bonus:Number(getVal('inpCanvasBonus',defaultItems.canvas_bonus))||0,
  landmark_prob:Number(getVal('inpLandmarkProb',defaultItems.landmark_prob))||0,
  landmark_fail:Number(getVal('inpLandmarkFail',defaultItems.landmark_fail))||0,
  landmark_bonus:Number(getVal('inpLandmarkBonus',defaultItems.landmark_bonus))||0,
  lookout_cost_mult:Number(getVal('inpLookoutCost',defaultItems.lookout_cost_mult))||0,
  drone_cost_mult:Number(getVal('inpDroneCost',defaultItems.drone_cost_mult))||0,
  nozzle_cost_mult:Number(getVal('inpNozzleCost',defaultItems.nozzle_cost_mult))||0,
  template_cost_mult:Number(getVal('inpTemplateCost',defaultItems.template_cost_mult))||0,
  money_cap:Number(getVal('inpMoneyCap',defaultMoneyCap))||defaultMoneyCap,
  mult_cap:Number(getVal('inpMultCap',defaultMultCap))||defaultMultCap,
  alpha_by_bet:Number(getVal('inpAlphaByBet',defaultAlpha))||defaultAlpha,
  post40_abs_bump:Number(getVal('inpPost40Bump',defaultItems.post40_abs_bump))||defaultItems.post40_abs_bump,
  min_fail_after_45:Number(getVal('inpMinFailAfter45',defaultItems.min_fail_after_45))||defaultItems.min_fail_after_45,
  reward_scale:1.0, base_fail_scale:1.0,
  use_nozzle_cashout_x15: !!document.getElementById('chkUseNozzle')?.checked
}}
function applyZoneLambda(baseFail,lam1,lam2,lam3,cfg){
  const p=baseFail.map(x=> Math.max(0, Math.min(1, x*cfg.base_fail_scale)));
  for(let i=39;i<=48;i++) p[i]=Math.max(0, Math.min(1, p[i]+cfg.post40_abs_bump));
  for(let i=0;i<50;i++){ const lam=i<30?lam1:(i<40?lam2:lam3); p[i]=oddsScale(p[i],lam) }
  for(let i=44;i<=48;i++) p[i]=Math.max(p[i],cfg.min_fail_after_45);
  return p
}
function effectiveMult(mult,bet,cfg){ const caps=[cfg.money_cap/bet, cfg.mult_cap, cfg.alpha_by_bet*(cfg.money_cap/bet)]; return Math.min(mult,...caps) }
function bestStopNoItems(rewards,pFail,bet,cfg){ const cap=effectiveMult(1e9,bet,cfg); const {ev}=evCurve(rewards,pFail,cap); return argmax(ev)+1 }
function simulateRound(bet,rewards,pFail,rng,cfg){
  let lookout=1,drone=1,template=1; let cost=0,step=0,alive=true,mult=1.0,bonus=0.0,droneBuf=0;
  const nozzleBuff = cfg.use_nozzle_cashout_x15;
  if(nozzleBuff){ cost += cfg.nozzle_cost_mult * bet; }

  const stop=bestStopNoItems(rewards,pFail,bet,cfg);
  while(alive&&step<stop){
    const next=step+1;
    const isCanvas=(next<=35)&&(rng()<cfg.canvas_prob);
    const isLandmark=(next>=28&&next<=44)&&(rng()<cfg.landmark_prob);

    if(drone>0&&(next===41||next===43||next===45)&&!isLandmark){ droneBuf=1; drone--; cost+=cfg.drone_cost_mult*bet }
    const stepFail=isLandmark?cfg.landmark_fail:pFail[next-1];
    const effFail=(droneBuf===1&&!isLandmark)?0.0:stepFail;
    if(droneBuf===1&&!isLandmark) droneBuf=0;

    if(rng()<effFail){
      if(lookout>0){lookout--; cost+=cfg.lookout_cost_mult*bet}
      else { alive=false; break }
    } else {
      step=next; mult=rewards[step-1]*cfg.reward_scale;
      if(isCanvas) mult+=cfg.canvas_bonus;
      if(isLandmark) bonus+=cfg.landmark_bonus;
    }
  }
  let payout=0;
  if(alive&&step>=1){
    let total=mult+bonus;
    total=effectiveMult(total,bet,cfg);
    payout = total * bet;
    if(nozzleBuff) payout *= 1.5;
  }
  return Math.max(0,payout-cost)
}
function simulateMany(params){
  const {bet,sims,rewards,baseFail,lam1,lam2,lam3,cfg}=params;
  const pFail=applyZoneLambda(baseFail,lam1,lam2,lam3,cfg);
  let sum=0,sum2=0; const rng=Math.random;
  for(let i=0;i<sims;i++){ const v=simulateRound(bet,rewards,pFail,rng,cfg); sum+=v; sum2+=v*v }
  const mean=sum/sims; const std=Math.sqrt(Math.max(0,sum2/sims-mean*mean)); const rtp=sum/(bet*sims);
  return {rtp,mean,std}
}
function runAdvanced(){
  const bet=Number(getVal('inpBet',1))||1;
  const sims=Number(getVal('inpSims',20000))||20000;
  const lam1=Number(getVal('inpLam1',defaultLam[0]))||defaultLam[0];
  const lam2=Number(getVal('inpLam2',defaultLam[1]))||defaultLam[1];
  const lam3=Number(getVal('inpLam3',defaultLam[2]))||defaultLam[2];
  const rewards=parseList(getVal('inpRewards',''));
  const baseFailPct=parseList(getVal('inpBaseFail',''));
  const s50=clamp(Number(getVal('inpS50',0.7))||0.7,0,1);
  if(rewards.length!==50||baseFailPct.length!==49){ alert('è«‹å…ˆæ­£ç¢ºå¡«å…¥å€ç‡èˆ‡å¤±æ•—ç‡'); return }
  const baseFail=baseFailPct.map(x=>x/100); baseFail.push(1-s50);
  const res=simulateMany({bet,sims,rewards,baseFail,lam1,lam2,lam3,cfg:getCfg()});
  const cls=(res.rtp>0.97||res.rtp<0.95)?'warn':'ok';
  setHTML('advResult',`
    <div><div class="muted">RTP</div><div class="kpi ${cls}">${fmtPct(res.rtp)}</div></div>
    <div><div class="muted">Mean payout</div><div class="kpi">${fmtMoney(res.mean)}</div></div>
    <div><div class="muted">Std payout</div><div class="kpi">${fmtMoney(res.std)}</div></div>`);
  return res;
}

// == Precise Auto Tuner (multi-parameter, progress UI) ==
let cancelFlag=false;
function setProgress(pct,msg){ const bar=$('calibBar'); const box=$('calibProgressBox'); const m=$('calibMsg'); if(box) box.style.display='block'; if(bar) bar.style.width=(pct*100).toFixed(1)+'%'; if(m) m.textContent=msg }
function hideProgress(){ const box=$('calibProgressBox'); if(box) box.style.display='none' }

async function preciseAutoCalibrate(){
  cancelFlag=false; $('btnCancel').onclick=()=>{ cancelFlag=true; setProgress(0,'å·²å–æ¶ˆ'); };
  const target=Number(getVal('inpTarget',0.96))||0.96;
  const bet=Number(getVal('inpBet',1))||1;
  const rewards0=parseList(getVal('inpRewards',''));
  const baseFailPct=parseList(getVal('inpBaseFail',''));
  const s50=clamp(Number(getVal('inpS50',0.7))||0.7,0,1);
  if(rewards0.length!==50||baseFailPct.length!==49){ alert('è«‹å…ˆæ­£ç¢ºå¡«å…¥å€ç‡èˆ‡å¤±æ•—ç‡'); return }
  const baseFail0=baseFailPct.map(x=>x/100); baseFail0.push(1-s50);

  const includeTailTune = $('chkAlsoTuneTail').checked;
  const GEN=6, POP=14;
  const simsCoarse=15000;
  const simsFine=120000;
  const mutate = (v,rate,lo,hi)=> Math.max(lo, Math.min(hi, v*(1+(Math.random()*2-1)*rate)));

  let seed = {
    lam1:Number(getVal('inpLam1',defaultLam[0]))||defaultLam[0],
    lam2:Number(getVal('inpLam2',defaultLam[1]))||defaultLam[1],
    lam3:Number(getVal('inpLam3',defaultLam[2]))||defaultLam[2],
    reward_scale:1.00,
    base_fail_scale:1.00,
    post40_abs_bump:Number(getVal('inpPost40Bump',defaultItems.post40_abs_bump))||defaultItems.post40_abs_bump,
    min_fail_after_45:Number(getVal('inpMinFailAfter45',defaultItems.min_fail_after_45))||defaultItems.min_fail_after_45
  };

  const bounds = {
    lam1:[0.8,3.0], lam2:[1.0,3.5], lam3:[2.0,12.0],
    reward_scale:[0.85,1.15], base_fail_scale:[0.6,1.6],
    post40_abs_bump:[0.00,0.20], min_fail_after_45:[0.40,0.80]
  };

  function mkCfg(vec){ return Object.assign(getCfg(), { reward_scale:vec.reward_scale, base_fail_scale:vec.base_fail_scale, post40_abs_bump:vec.post40_abs_bump, min_fail_after_45:vec.min_fail_after_45 }) }
  function evalOne(vec, sims){
    const cfg=mkCfg(vec);
    const res=simulateMany({bet,sims,rewards:rewards0.map(r=>r*vec.reward_scale),baseFail:baseFail0,lam1:vec.lam1,lam2:vec.lam2,lam3:vec.lam3,cfg});
    return {vec, res, score: Math.abs(res.rtp - target) }
  }

  let pop=[];
  for(let i=0;i<POP;i++){
    const v=JSON.parse(JSON.stringify(seed));
    v.lam1 = mutate(v.lam1,0.2,bounds.lam1[0],bounds.lam1[1]);
    v.lam2 = mutate(v.lam2,0.2,bounds.lam2[0],bounds.lam2[1]);
    v.lam3 = mutate(v.lam3,0.2,bounds.lam3[0],bounds.lam3[1]);
    if(includeTailTune){
      v.reward_scale = mutate(v.reward_scale,0.1,bounds.reward_scale[0],bounds.reward_scale[1]);
      v.base_fail_scale = mutate(v.base_fail_scale,0.2,bounds.base_fail_scale[0],bounds.base_fail_scale[1]);
      v.post40_abs_bump = mutate(v.post40_abs_bump,0.5,bounds.post40_abs_bump[0],bounds.post40_abs_bump[1]);
      v.min_fail_after_45 = mutate(v.min_fail_after_45,0.2,bounds.min_fail_after_45[0],bounds.min_fail_after_45[1]);
    }
    pop.push(v);
  }

  let best=null; let totalSteps=GEN*POP + 1; let step=0;
  for(let g=0; g<GEN; g++){
    if(cancelFlag) return hideProgress();
    setProgress(step/totalSteps, `ç¬¬ ${g+1}/${GEN} ä»£ï¼šè©•ä¼°ä¸­...`);
    let scored=[];
    for(let i=0;i<POP;i++){
      if(cancelFlag) return hideProgress();
      const s=evalOne(pop[i], simsCoarse);
      scored.push(s);
      step++; setProgress(step/totalSteps, `ç¬¬ ${g+1}/${GEN} ä»£ï¼š${i+1}/${POP} å·²å®Œæˆï¼ŒRTP=${fmtPct(s.res.rtp)}`);
      await new Promise(r=>setTimeout(r,0));
    }
    scored.sort((a,b)=>a.score-b.score);
    if(!best || scored[0].score < best.score) best=scored[0];
    const K=Math.max(3, Math.floor(POP*0.3));
    const elites = scored.slice(0,K).map(s=>s.vec);
    const next=[];
    while(next.length<POP){
      const parent = elites[Math.floor(Math.random()*elites.length)];
      const child = JSON.parse(JSON.stringify(parent));
      child.lam1 = mutate(child.lam1,0.15,bounds.lam1[0],bounds.lam1[1]);
      child.lam2 = mutate(child.lam2,0.15,bounds.lam2[0],bounds.lam2[1]);
      child.lam3 = mutate(child.lam3,0.15,bounds.lam3[0],bounds.lam3[1]);
      if(includeTailTune){
        child.reward_scale = mutate(child.reward_scale,0.08,bounds.reward_scale[0],bounds.reward_scale[1]);
        child.base_fail_scale = mutate(child.base_fail_scale,0.15,bounds.base_fail_scale[0],bounds.base_fail_scale[1]);
        child.post40_abs_bump = mutate(child.post40_abs_bump,0.3,bounds.post40_abs_bump[0],bounds.post40_abs_bump[1]);
        child.min_fail_after_45 = mutate(child.min_fail_after_45,0.12,bounds.min_fail_after_45[0],bounds.min_fail_after_45[1]);
      }
      next.push(child);
    }
    pop=next;
  }

  if(cancelFlag) return hideProgress();
  setProgress(step/totalSteps, 'æœ€çµ‚ç²¾ç®—ä¸­...');
  const final = evalOne(best.vec, simsFine);
  step++; setProgress(step/totalSteps, `å®Œæˆï¼šRTP=${fmtPct(final.res.rtp)}ï¼ˆèª¤å·® ${(Math.abs(final.res.rtp-target)*100).toFixed(2)}%ï¼‰`);
  setTimeout(()=>hideProgress(), 1200);

  setVal('inpLam1', final.vec.lam1.toFixed(4));
  setVal('inpLam2', final.vec.lam2.toFixed(4));
  setVal('inpLam3', final.vec.lam3.toFixed(4));
  setVal('inpPost40Bump', final.vec.post40_abs_bump.toFixed(4));
  setVal('inpMinFailAfter45', final.vec.min_fail_after_45.toFixed(4));
  const rew=parseList(getVal('inpRewards',''));
  const rew2=rew.map(r=> (r*final.vec.reward_scale).toFixed(6));
  setVal('inpRewards', rew2.join(','));
  const bf=parseList(getVal('inpBaseFail',''));
  const bf2=bf.map(x=> (x*final.vec.base_fail_scale).toFixed(4));
  setVal('inpBaseFail', bf2.join(','));

  const r=runAdvanced();
  const extra = document.createElement('div');
  extra.className='muted small';
  extra.textContent = `Î»1/2/3 = ${final.vec.lam1.toFixed(3)} / ${final.vec.lam2.toFixed(3)} / ${final.vec.lam3.toFixed(3)}ï¼Œå€ç‡ç¸®æ”¾=${final.vec.reward_scale.toFixed(3)}ï¼Œé¢¨éšªç¸®æ”¾=${final.vec.base_fail_scale.toFixed(3)}ï¼Œå°¾æ®µ(40â€“49)+=${final.vec.post40_abs_bump.toFixed(3)}ï¼Œâ‰¥45ä¸‹é™=${final.vec.min_fail_after_45.toFixed(3)}`;
  document.getElementById('advResult').appendChild(extra);
}

// == Share & README ==
function syncToURL(){
  const params=new URLSearchParams();
  ['inpTarget','inpS50','inpMoneyCap','inpMultCap','inpAlphaByBet','inpBet','inpSims','inpLam1','inpLam2','inpLam3'].forEach(id=> params.set(id, getVal(id,'')));
  params.set('rewards', getVal('inpRewards','')); params.set('baseFail', getVal('inpBaseFail',''));
  ['inpCanvasProb','inpCanvasBonus','inpLandmarkProb','inpLandmarkFail','inpLandmarkBonus','inpLookoutCost','inpDroneCost','inpNozzleCost','inpTemplateCost','inpPost40Bump','inpMinFailAfter45'].forEach(id=> params.set(id, getVal(id,'')));
  const url=location.origin+location.pathname+'?'+params.toString(); navigator.clipboard.writeText(url).then(()=> alert('å·²è¤‡è£½ç›®å‰è¨­å®šçš„åˆ†äº«é€£çµ'))
}
function openReadme(){ const md=$('mdReadme'); const body=$('mdBody'); if(md&&body){ body.textContent = README_TEXT.text; md.style.display='flex'; } }
function closeReadme(){ const md=$('mdReadme'); if(md) md.style.display='none' }

// == Wire up ==
document.addEventListener('DOMContentLoaded', ()=>{
  loadDefaults96();
  document.getElementById('btnCalibrate').onclick=calibrate;
  document.getElementById('btnExportSpec').onclick=exportSpec;
  document.getElementById('btnExportAlerts').onclick=exportAlerts;
  document.getElementById('btnRunAdv').onclick=runAdvanced;
  document.getElementById('btnCalibAdv').onclick=preciseAutoCalibrate;
  document.getElementById('btnShare').onclick=syncToURL;
  document.getElementById('btnReset').onclick=()=>{ loadDefaults96(); document.getElementById('advResult').innerHTML=''; document.getElementById('tblSpec').innerHTML=''; document.getElementById('calibKPI').innerHTML=''; };
  document.getElementById('btnReadme').onclick=openReadme;
  document.getElementById('btnCloseReadme').onclick=closeReadme;
  document.getElementById('btnTuneHelp').onclick = () => {
    alert(
      [
        'å‹¾é¸å¾Œï¼Œã€Œé€²éšè‡ªå‹•æ ¡æº–ã€æœƒåŒæ™‚èª¿æ•´ï¼š',
        'â€¢ å°¾æ®µä¸‹é™ï¼šâ‰¥45 æ­¥çš„æœ€å°å¤±æ•—ç‡ä¸‹é™',
        'â€¢ å¾Œæ®µé¢¨éšªï¼š40â€“49 æ­¥é¡å¤–çš„çµ•å°å¤±æ•—ç‡åŠ æˆ',
        'â€¢ å€ç‡ç¸®æ”¾ï¼šæ•´æ¢å€ç‡æ›²ç·šçš„å…¨å±€ç¸®æ”¾ï¼ˆreward_scaleï¼‰',
        'â€¢ åŸºæº–é¢¨éšªç¸®æ”¾ï¼šåŸºæº–å¤±æ•—ç‡çš„å…¨å±€ç¸®æ”¾ï¼ˆbase_fail_scaleï¼‰',
        '',
        'â€» æ–°è¦ï¼šç²¾å¯†å·¥å…·(å™´é ­) æ”¹ç‚ºã€Œå…Œç¾ä¹˜ 1.5xã€ï¼Œæ˜¯å¦è³¼è²·ç”±å‹¾é¸æ¡†æ±ºå®šï¼Œæˆæœ¬=ä¸‹æ³¨é¡Ã—è¨­å®šæˆæœ¬å€ç‡ã€‚'
      ].join('
')
    );
  };
  // é¦–æ¬¡è·‘ä¸€æ¬¡
  runAdvanced();
});
</script>
</body>
</html>
