# 金庫神偷｜RTP 模擬器（含道具／曲線破壞者）README

本工具是《金庫神偷》用的瀏覽器端模擬器，用於**驗證獎勵曲線、風險曲線、RTP**，並支援**道具／曲線破壞者**的參數化模擬與**自動校準**。將此 `readme.md` 與模擬器 HTML 放在**同一資料夾**，即可在頁面點「**開啟使用說明 (README)**」直接閱讀。

---

## 🔰 快速開始（Quick Start）
1. 開啟 HTML（建議以 GitHub Pages 或任意靜態主機托管）。  
2. 左側填入：
   - **目標 RTP**（預設 0.96）
   - **Step50 成功率**（預設 0.7）
   - **金額上限（$）**、**倍率上限（x）**
   - **50 步倍率**、**基準失敗率 %（49 項）**
3. 按下 **自動校準（基礎＋上限）** → 會計算單一 λ，讓**最佳停步**的 EV ≈ 0.96。  
4. 右側可設定道具與破壞者參數，選擇下注額與模擬局數，按 **執行進階模擬** 觀察 RTP/均值/波動。  
5. 需要時按 **進階自動校準到 96%** → 搜尋 λ₁/λ₂/λ₃ 以逼近目標 RTP（在你目前的道具設定下）。  
6. **匯出規格 CSV** / **匯出警戒 CSV**，或 **複製目前設定連結** 分享給團隊。

---

## 📥 輸入欄位說明（Inputs）

### 基礎＋上限
- **目標 RTP**：目標期望回報率，通常 0.96。  
- **Step50 成功率（0~1）**：第 50 步的成功機率（例如 0.7 代表 70% 成功、30% 失敗）。  
- **金額上限（$）**：真實出款上限。  
- **倍率上限（x）**：倍率本身的硬上限。  
- **50 步倍率**：長度 50 的倍率表，對應 step1~step50。  
- **基準失敗率 %（49 項）**：前 49 步的失敗率（百分比）。第 50 步以 **1-成功率** 推得。  

> **等效倍率上限**（校準時使用）：`cap = min(倍率上限, 金額上限 / 1)`，假設基準下注額 bet=1。

### 進階模擬（道具／曲線破壞者）
- **下注額（$）**、**模擬局數**。  
- **λ1（步 1–30）**、**λ2（步 31–40）**、**λ3（步 41–50）**：區段風險縮放倍率。  
- **高級(絕佳)**：`機率`、`加成(x)` → 觸發時加到當步倍率。  
- **華麗(地標)**：`機率`、`失敗率`、`獎勵(x)` → 區間(預設 28–44)觸發額外獎勵與更高失敗率。  
- **防爆盾(把風) 成本 ×bet**：首次失敗可抵銷一次失敗；使用時扣成本。  
- **聽診器(無人機) 成本 ×bet**：於 41/43/45 步作檢測，該步可視為安全一次；使用時扣成本。  
- **精密工具(噴頭) 成本 ×bet**：於第 45 步將倍率加倍；使用時扣成本。  
- **破解器(模版) 成本 ×bet**：於第 35 步直接跳至 38 步；使用時扣成本。  
- **後段 +絕對風險 (40–49)**：在第 40–49 步額外加上一個**絕對失敗率**（再進行縮放與下限處理）。  
- **最小失敗率 (≥45)**：第 45–49 步的失敗率下限。  
- **下注額上限係數 α**：在進階模擬中，出款上限使用 `min(倍率上限, 金額上限/bet, α×金額上限/bet)` 加強控制。

---

## 🧮 計算與演算法（核心公式）

### 風險縮放（odds scaling）
對原始失敗率 `p` 套用 λ：
```
odds = p / (1 - p)
odds' = λ × odds
p' = odds' / (1 + odds') = (λp) / (1 - p + λp)
```
> 區段 λ₁/λ₂/λ₃ 依步數套用；此外在 40–49 步會先加上「後段 +絕對風險」，45–49 步有「最小失敗率」下限。

### 存活與期望
- **ReachProb(before step k)**：到達第 k 步前仍存活的機率。  
- **AfterProb(through step k)**：通過第 k 步後仍存活的機率。  
- **EV_at_step(k)**：`min(倍率[k], 上限) × AfterProb(k)`。

### 上限規則
- **基礎校準**使用 `cap = min(倍率上限, 金額上限/1)`。  
- **進階模擬**使用 `cap(bet) = min(倍率上限, 金額上限/bet, α×金額上限/bet)`。

---

## ▶️ 操作按鈕（Actions）
- **自動校準（基礎＋上限）**：以二分搜尋 λ，使 `max(EV_at_step)` 接近目標 RTP。  
- **匯出規格 CSV**：輸出每步的倍率、縮放後失敗率、Reach/AfterProb、EV、是否超標。  
- **匯出警戒 CSV**：列出 EV 高於目標步。  
- **執行進階模擬**：在當前道具設定、下注額與 λ₁/₂/₃ 下進行隨機模擬，輸出 RTP/平均/標準差。  
- **進階自動校準到 96%**：粗格點 + 協調下降搜尋 λ₁/₂/₃ 以逼近目標 RTP。  
- **複製目前設定連結**：將當前表單序列化到網址。  
- **重設為預設值**：回復所有欄位到預設。  
- **開啟使用說明 (README)**：讀取同目錄下的 `readme.md`。

---

## 📤 報表欄位（CSV）
- `Step`、`RewardMultiplier`  
- `ScaledFailProb(odds, lambda=...)`、`ScaledSurvivalProb`  
- `ReachProb(before step)`、`AfterProb(through step)`  
- `EV_at_step(with caps)`、`Alert(>target)`

---

## ✅ 內建自我測試（Self-tests）
載入後會自動檢查：
1. 必備 DOM 元件存在。  
2. `oddsScale(.,1)` 近似恆等。  
3. `afterProbs` 回傳長度 50。  
4. `calibrate()` 能成功設定 `lastCalib`。  
5. `runOnceRTP()` 會回傳數值。  
6. `runAdvanced()` 能寫入結果區塊。  
7. 區段下限（≥45）確實生效。

---

## 🔎 疑難排解（Troubleshooting）
- **頁面出現紅色錯誤框**：代表必備 DOM 元件缺失（HTML 未完整）；請以完整檔案部署。  
- **readme.md 無法開啟**：需與 HTML 位於**同一目錄**且由同源伺服器提供；本機 `file://` 有可能受限。  
- **NaN/undefined**：常見於倍率/失敗率長度不正確（倍率 50、失敗率 49），或欄位空白。  
- **RTP 跑不下來**：可調高 `λ3`、加強後段失敗率（`後段 +絕對風險`、`最小失敗率`）、降低加成/獎勵。

---

## 🧪 建議測試案例（Test Cases）
1. **預設值 smoke test**：直接校準 + 進階模擬，應產生結果且無錯誤。  
2. **道具關閉**：將「高級(絕佳) 機率」「華麗(地標) 機率」與各道具成本設為 0，RTP 應下修、波動降低。  
3. **尾端加強風險**：`λ3` 調高、`最小失敗率` 調高，RTP 應下降、最佳步數通常前移。  
4. **上限壓制**：降低「倍率上限」與「α」，觀察 EV 曲線明顯受限。

---

## 📌 備註
- 「進階自動校準到 96%」**只調整 λ₁/λ₂/λ₃**；若需一併搜尋道具參數，可告知要納入哪些維度（例如僅 `華麗(地標)` 的機率和獎勵）。  
- 若需輸出英文版說明、或將 CSV 欄位改為中文名，也可加開分支版本。

---

© 2025 Vault Heist (金庫神偷) – Simulator Docs
